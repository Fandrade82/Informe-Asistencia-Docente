<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descargar Proyecto - Informe de Asistencia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 800px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .file-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .file-icon {
            font-size: 24px;
        }
        
        .file-info h3 {
            font-size: 14px;
            color: #333;
            margin-bottom: 3px;
        }
        
        .file-info p {
            font-size: 12px;
            color: #666;
            margin: 0;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .instructions {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .instructions h3 {
            color: #856404;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
            color: #856404;
        }
        
        .instructions li {
            margin: 8px 0;
        }
        
        .success-message {
            display: none;
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            color: #155724;
        }
        
        .success-message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>üì¶</span>
            Sistema de Informe de Asistencia
        </h1>
        <p class="subtitle">Descarga el proyecto completo listo para usar</p>
        
        <div class="file-list">
            <h2 style="font-size: 16px; margin-bottom: 15px; color: #667eea;">üìÅ Archivos incluidos:</h2>
            
            <div class="file-item">
                <div class="file-icon">üêç</div>
                <div class="file-info">
                    <h3>app.py</h3>
                    <p>Aplicaci√≥n Flask principal con toda la l√≥gica</p>
                </div>
            </div>
            
            <div class="file-item">
                <div class="file-icon">üé®</div>
                <div class="file-info">
                    <h3>templates/index.html</h3>
                    <p>Interfaz de usuario moderna con Bootstrap 5</p>
                </div>
            </div>
            
            <div class="file-item">
                <div class="file-icon">üìã</div>
                <div class="file-info">
                    <h3>requirements.txt</h3>
                    <p>Dependencias del proyecto (Flask, pandas, openpyxl)</p>
                </div>
            </div>
            
            <div class="file-item">
                <div class="file-icon">üìñ</div>
                <div class="file-info">
                    <h3>README.md</h3>
                    <p>Documentaci√≥n completa con instrucciones</p>
                </div>
            </div>
        </div>
        
        <button class="download-btn" onclick="downloadProject()">
            <span>‚¨áÔ∏è</span>
            Descargar Proyecto Completo (ZIP)
        </button>
        
        <div id="successMessage" class="success-message">
            ‚úÖ ¬°Descarga iniciada! El archivo ZIP se guardar√° en tu carpeta de descargas.
        </div>
        
        <div class="instructions">
            <h3>üìù Instrucciones despu√©s de descargar:</h3>
            <ol>
                <li>Extrae el archivo ZIP en tu carpeta preferida</li>
                <li>Abre una terminal/CMD en esa carpeta</li>
                <li>Ejecuta: <code style="background: #fff; padding: 2px 5px; border-radius: 3px;">pip install -r requirements.txt</code></li>
                <li>Ejecuta: <code style="background: #fff; padding: 2px 5px; border-radius: 3px;">python app.py</code></li>
                <li>Abre tu navegador en: <code style="background: #fff; padding: 2px 5px; border-radius: 3px;">http://127.0.0.1:5000</code></li>
            </ol>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const files = {
            'app.py': `# ============================================
# app.py - Sistema de Informe de Asistencia
# ============================================

from flask import Flask, request, send_file, render_template, flash, redirect, url_for
import pandas as pd
from openpyxl import Workbook
from openpyxl.styles import PatternFill, Font, Alignment
import datetime
import os
import tempfile

app = Flask(__name__)
app.secret_key = 'tu_clave_secreta_aqui_cambiar_en_produccion'
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB max

# Columnas requeridas en el Excel
REQUIRED_COLUMNS = ['Apellido y Nombre', 'Departamento', 'Semana']

def validate_excel(df):
    """Valida que el DataFrame tenga las columnas necesarias"""
    df.columns = df.columns.str.strip()
    missing = [col for col in REQUIRED_COLUMNS if col not in df.columns]
    if missing:
        return False, f"Faltan columnas requeridas: {', '.join(missing)}"
    return True, "OK"

def generate_report(df):
    """Genera el reporte Excel con formato"""
    wb = Workbook()
    ws = wb.active
    ws.title = "Informe"
    
    # Estilos
    header_fill = PatternFill(start_color="0000FF", end_color="0000FF", fill_type="solid")
    header_font = Font(color="FFFFFF", bold=True)
    yellow_fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")
    center_align = Alignment(horizontal="center", vertical="center")
    
    docentes = df['Apellido y Nombre'].unique()
    row_num = 1
    
    for docente in docentes:
        # Encabezado del docente
        ws.merge_cells(start_row=row_num, start_column=1, end_row=row_num, end_column=10)
        cell = ws.cell(row=row_num, column=1, value=docente)
        cell.font = Font(bold=True, size=12)
        cell.alignment = center_align
        cell.fill = PatternFill(start_color="E0E0E0", end_color="E0E0E0", fill_type="solid")
        row_num += 1
        
        # Filtrar datos del docente
        subset = df[df['Apellido y Nombre'] == docente].copy()
        columns = list(subset.columns) + ['Observaci√≥n']
        
        # Encabezados de columnas
        for col_num, col_name in enumerate(columns, 1):
            cell = ws.cell(row=row_num, column=col_num, value=col_name)
            cell.fill = header_fill
            cell.font = header_font
            cell.alignment = center_align
        row_num += 1
        
        # Datos del docente
        for _, row in subset.iterrows():
            jornada = str(row.get('Departamento', '')).strip().upper()
            dia_semana = str(row.get('Semana', '')).strip().lower()
            
            # L√≥gica de verificaci√≥n
            verificar = False
            if jornada.startswith('ADMIN'):
                verificar = True
            elif jornada.startswith('DOC') and dia_semana == 'jueves':
                verificar = True
            
            # Verificar marcaciones
            observacion = ''
            hora3 = row.get('Hora3')
            hora4 = row.get('Hora4')
            
            if verificar:
                hora3_vacia = pd.isna(hora3) or (isinstance(hora3, str) and not hora3.strip())
                hora4_vacia = pd.isna(hora4) or (isinstance(hora4, str) and not hora4.strip())
                
                if hora3_vacia or hora4_vacia:
                    observacion = 'No marca'
            
            # Escribir datos de la fila
            for col_num, col_name in enumerate(subset.columns, 1):
                valor = row.get(col_name)
                if pd.isna(valor):
                    valor = ''
                
                cell = ws.cell(row=row_num, column=col_num, value=valor)
                if observacion == 'No marca':
                    cell.fill = yellow_fill
                cell.alignment = center_align
            
            # Columna de observaci√≥n
            cell = ws.cell(row=row_num, column=len(subset.columns)+1, value=observacion)
            if observacion == 'No marca':
                cell.fill = yellow_fill
                cell.font = Font(bold=True)
            cell.alignment = center_align
            row_num += 1
        
        row_num += 1
    
    # Ajustar ancho de columnas
    for column in ws.columns:
        max_length = 0
        column = list(column)
        for cell in column:
            try:
                if cell.value:
                    cell_length = len(str(cell.value))
                    if cell_length > max_length:
                        max_length = cell_length
            except:
                pass
        adjusted_width = min(max_length + 2, 50)
        ws.column_dimensions[column[0].column_letter].width = adjusted_width
    
    return wb

@app.route('/', methods=['GET', 'POST'])
def upload_file():
    if request.method == 'POST':
        # Verificar que se subi√≥ un archivo
        if 'file' not in request.files:
            flash('No se seleccion√≥ ning√∫n archivo', 'error')
            return redirect(request.url)
        
        file = request.files['file']
        
        # Verificar que el archivo tiene nombre
        if file.filename == '':
            flash('No se seleccion√≥ ning√∫n archivo', 'error')
            return redirect(request.url)
        
        # Verificar extensi√≥n
        if not file.filename.lower().endswith(('.xlsx', '.xls')):
            flash('Solo se permiten archivos Excel (.xlsx, .xls)', 'error')
            return redirect(request.url)
        
        try:
            # Leer el archivo Excel
            df = pd.read_excel(file, engine='openpyxl')
            
            # Verificar que el DataFrame no est√© vac√≠o
            if df.empty:
                flash('El archivo Excel est√° vac√≠o', 'error')
                return redirect(request.url)
            
            # Validar columnas
            valid, message = validate_excel(df)
            if not valid:
                flash(message, 'error')
                return redirect(request.url)
            
            # Generar reporte
            wb = generate_report(df)
            
            # Guardar en archivo temporal
            fecha = datetime.datetime.now().strftime('%Y-%m-%d_%H-%M-%S')
            temp_dir = tempfile.gettempdir()
            output_path = os.path.join(temp_dir, f"Informe_Asistencia_{fecha}.xlsx")
            wb.save(output_path)
            
            # Enviar archivo y programar eliminaci√≥n
            response = send_file(
                output_path, 
                as_attachment=True,
                download_name=f"Informe_Asistencia_{fecha}.xlsx",
                mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            )
            
            # Eliminar archivo despu√©s de enviarlo
            @response.call_on_close
            def cleanup():
                try:
                    if os.path.exists(output_path):
                        os.remove(output_path)
                        print(f"‚úì Archivo temporal eliminado: {output_path}")
                except Exception as e:
                    print(f"‚ö† Error al eliminar archivo temporal: {e}")
            
            return response
            
        except pd.errors.EmptyDataError:
            flash('El archivo Excel est√° vac√≠o o corrupto', 'error')
            return redirect(request.url)
        except Exception as e:
            flash(f'Error al procesar el archivo: {str(e)}', 'error')
            print(f"Error detallado: {e}")
            return redirect(request.url)
    
    return render_template('index.html')

@app.errorhandler(413)
def too_large(e):
    flash('El archivo es demasiado grande. M√°ximo permitido: 16MB', 'error')
    return redirect(url_for('upload_file'))

@app.errorhandler(500)
def internal_error(e):
    flash('Error interno del servidor. Por favor intenta nuevamente.', 'error')
    return redirect(url_for('upload_file'))

if __name__ == '__main__':
    print("=" * 60)
    print("üöÄ Servidor iniciado correctamente")
    print("üìç URL: http://127.0.0.1:5000")
    print("üìÅ Aseg√∫rate de tener la carpeta 'templates' con index.html")
    print("=" * 60)
    app.run(debug=True, host='0.0.0.0', port=5000)`,

            'templates/index.html': `<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Informe de Asistencia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }
        
        .main-container { 
            max-width: 700px; 
            margin: 50px auto;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border: none;
        }
        
        .card-header h2 {
            margin: 0;
            font-weight: 600;
        }
        
        .card-header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .upload-zone {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
            margin-bottom: 20px;
        }
        
        .upload-zone:hover {
            border-color: #764ba2;
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        
        .upload-zone.dragover {
            border-color: #28a745;
            background: #e8f5e9;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .file-preview {
            display: none;
            margin-top: 15px;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 5px;
            color: #0066cc;
        }
        
        .file-preview.show {
            display: block;
        }
        
        .btn-process {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-process:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-process:disabled {
            opacity: 0.7;
        }
        
        .requirements-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .requirements-card h6 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .requirements-card ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .requirements-card li {
            margin: 5px 0;
            font-size: 14px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="card">
            <div class="card-header">
                <h2><i class="bi bi-file-earmark-spreadsheet"></i> Informe de Asistencia</h2>
                <p>Generador automatizado de reportes Excel</p>
            </div>
            <div class="card-body p-4">
                <!-- Mensajes Flash -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }}"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Formulario -->
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">
                            <i class="bi bi-cloud-upload"></i>
                        </div>
                        <h5 class="text-muted mb-2">Arrastra tu archivo aqu√≠</h5>
                        <p class="text-muted mb-0">o haz clic para seleccionar</p>
                        <small class="text-muted d-block mt-2">Formatos: .xlsx, .xls (m√°x. 16MB)</small>
                        
                        <input type="file" 
                               class="d-none" 
                               name="file" 
                               id="fileInput" 
                               accept=".xlsx,.xls" 
                               required 
                               onchange="updateFileName(this)">
                        
                        <div id="filePreview" class="file-preview">
                            <i class="bi bi-file-earmark-check"></i>
                            <strong id="fileName"></strong>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-process btn-primary w-100" id="submitBtn">
                        <span id="btnContent">
                            <i class="bi bi-gear"></i> Procesar y Generar Informe
                        </span>
                        <span id="btnLoading" class="d-none">
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            Procesando archivo...
                        </span>
                    </button>
                </form>

                <!-- Requisitos -->
                <div class="requirements-card">
                    <h6><i class="bi bi-info-circle"></i> Requisitos del archivo Excel</h6>
                    <ul class="mb-0">
                        <li><strong>Apellido y Nombre</strong> - Identificaci√≥n del docente</li>
                        <li><strong>Departamento</strong> - ADMIN o DOC + √°rea</li>
                        <li><strong>Semana</strong> - D√≠a de la semana</li>
                        <li><strong>Hora3, Hora4</strong> - Marcaciones (opcional)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function updateFileName(input) {
            const filePreview = document.getElementById('filePreview');
            const fileName = document.getElementById('fileName');
            const uploadZone = document.getElementById('uploadZone');
            
            if (input.files.length > 0) {
                fileName.textContent = input.files[0].name;
                filePreview.classList.add('show');
                uploadZone.style.borderColor = '#28a745';
            } else {
                filePreview.classList.remove('show');
                uploadZone.style.borderColor = '#667eea';
            }
        }

        // Manejo del formulario
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            const fileInput = document.getElementById('fileInput');
            const submitBtn = document.getElementById('submitBtn');
            const btnContent = document.getElementById('btnContent');
            const btnLoading = document.getElementById('btnLoading');
            
            if (!fileInput.files.length) {
                e.preventDefault();
                alert('Por favor selecciona un archivo');
                return;
            }
            
            submitBtn.disabled = true;
            btnContent.classList.add('d-none');
            btnLoading.classList.remove('d-none');
        });

        // Drag and Drop
        const uploadZone = document.getElementById('uploadZone');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => {
                uploadZone.classList.add('dragover');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => {
                uploadZone.classList.remove('dragover');
            }, false);
        });

        uploadZone.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            const fileInput = document.getElementById('fileInput');
            
            if (files.length > 0) {
                fileInput.files = files;
                updateFileName(fileInput);
            }
        }, false);

        // Prevenir submit m√∫ltiple
        let formSubmitted = false;
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            if (formSubmitted) {
                e.preventDefault();
                return false;
            }
            formSubmitted = true;
        });
    </script>
</body>
</html>
